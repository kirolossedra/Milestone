<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login / Register</title>

    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --background-color: #f8f9fa;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --danger-color:  #dc3545;
        }
        /* RESET */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
        body{
            display:flex;justify-content:center;align-items:center;
            min-height:100vh;
            background:linear-gradient(135deg,#4a6fa5,#90bafc);
        }
        /* CARD */
        .container{
            width:100%;max-width:450px;
            background:rgba(255,255,255,.95);
            border-radius:15px;padding:40px 32px;
            box-shadow:0 10px 30px rgba(0,0,0,.2);
            transition:transform .3s ease;
        }
        .container:hover{transform:translateY(-5px)}
        /* TABS */
        .tab-container{display:flex;margin-bottom:1.5rem;border-bottom:2px solid var(--border-color)}
        .tab{flex:1;text-align:center;padding:.75rem 0;cursor:pointer;font-weight:500;border-bottom:3px solid transparent;transition:border-color .3s,color .3s}
        .tab.active{border-color:var(--primary-color);color:var(--primary-color);font-weight:600}
        /* FORMS */
        .form{display:none}
        .form.active{display:block;animation:fade .3s}
        @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* INPUT GROUP */
        .input-box{position:relative;margin-bottom:25px}
        .input-box input{
            width:100%;padding:14px 16px;font-size:1rem;
            border:2px solid var(--border-color);border-radius:8px;background:transparent;outline:none;transition:border-color .3s
        }
        .input-box input:focus{border-color:var(--primary-color)}
        .input-box label{
            position:absolute;top:50%;left:18px;transform:translateY(-50%);
            color:#999;font-size:1rem;pointer-events:none;transition:all .25s ease;
        }
        .input-box input:focus + label,
        .input-box input:not(:placeholder-shown)+label{
            top:-10px;left:14px;font-size:.75rem;background:#fff;padding:0 6px;color:var(--primary-color)
        }
        /* BUTTON */
        .btn{
            width:100%;padding:12px;border:none;border-radius:8px;
            background:var(--primary-color);color:#fff;font-size:1rem;
            cursor:pointer;transition:background .3s
        }
        .btn:hover{background:var(--secondary-color)}
        /* MESSAGES */
        .message{margin-top:1rem;text-align:center;font-size:.9rem}
        .message.error{color:var(--danger-color)}
        .message.success{color:var(--success-color)}
    </style>
</head>
<body>
<div class="container">
    <!-- Tabs -->
    <div class="tab-container">
        <div id="login-tab"    class="tab active">Login</div>
        <div id="register-tab" class="tab">Register</div>
    </div>

    <!-- Login -->
    <form id="login-form" class="form active">
        <div class="input-box">
            <input type="email" id="login-email" placeholder=" " required>
            <label>Email</label>
        </div>
        <div class="input-box">
            <input type="password" id="login-password" placeholder=" " required>
            <label>Password</label>
        </div>
        <button type="submit" class="btn">Login</button>
        <div id="login-message" class="message"></div>
    </form>

    <!-- Register -->
    <form id="register-form" class="form">
        <div class="input-box">
            <input type="email" id="register-email" placeholder=" " required>
            <label>Email</label>
        </div>
        <div class="input-box">
            <input type="password" id="register-password" placeholder=" " required>
            <label>Password</label>
        </div>
        <button type="submit" class="btn">Register</button>
        <div id="register-message" class="message"></div>
    </form>
</div>

<!-- Firebase + Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import {
    getDatabase, ref, push, set, get,
    query, orderByChild, equalTo
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

/* ---------- Firebase config (UNCHANGED) ---------- */
const firebaseConfig = {
    apiKey:            "AIzaSyAjBbnm8F76BCb9C5fluUyoZ2QnMSXlHOo",
    authDomain:        "test-c7bf3.firebaseapp.com",
    databaseURL:       "https://test-c7bf3-default-rtdb.firebaseio.com",
    projectId:         "test-c7bf3",
    storageBucket:     "test-c7bf3.firebasestorage.app",
    messagingSenderId: "573697013702",
    appId:             "1:573697013702:web:fe132fc4d796c06bdbe4c7"
};
const app       = initializeApp(firebaseConfig);
const database  = getDatabase(app);

/* ---------- Tabs ---------- */
const loginTab      = document.getElementById('login-tab');
const registerTab   = document.getElementById('register-tab');
const loginForm     = document.getElementById('login-form');
const registerForm  = document.getElementById('register-form');
const loginMsg      = document.getElementById('login-message');
const registerMsg   = document.getElementById('register-message');

loginTab.onclick = () => {
    loginTab.classList.add('active'); registerTab.classList.remove('active');
    loginForm.classList.add('active'); registerForm.classList.remove('active');
    loginMsg.textContent='';
};
registerTab.onclick = () => {
    registerTab.classList.add('active'); loginTab.classList.remove('active');
    registerForm.classList.add('active'); loginForm.classList.remove('active');
    registerMsg.textContent='';
};

/* ---------- Registration ---------- */
registerForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const email    = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;

    try{
        const usersRef   = ref(database,'users');
        const snap       = await get(usersRef);
        const authority  = snap.exists()? snap.numChildren()+1 : 1;   // first user == 1
        await set(push(usersRef),{ email,password,authority,createdAt:new Date().toISOString() });

        registerMsg.textContent='Registration successful! You can now login.';
        registerMsg.className='message success';
        registerForm.reset();
    }catch(err){
        console.error('Registration error:',err);
        registerMsg.textContent='Registration failed: '+(err.message||err.code);
        registerMsg.className='message error';
    }
});

/* ---------- Login ---------- */
loginForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const email    = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;

    loginMsg.textContent='';
    try{
        const q   = query(ref(database,'users'), orderByChild('email'), equalTo(email));
        const ss  = await get(q);
        let ok=false;
        ss.forEach(child=>{
            const u=child.val();
            if(u.password===password){
                ok=true;
                if(u.authority===1){
                    window.location.href='kilostone.html';
                }else{
                    loginMsg.textContent='Access denied: insufficient authority level.';
                    loginMsg.className='message error';
                }
            }
        });
        if(!ok){
            loginMsg.textContent='Login failed: incorrect email or password.';
            loginMsg.className='message error';
        }
    }catch(err){
        console.error('Login error:',err);
        loginMsg.textContent='Login error: '+(err.message||err.code);
        loginMsg.className='message error';
    }
});
</script>
</body>
</html>
